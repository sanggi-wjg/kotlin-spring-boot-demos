apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: batch-common
  namespace: batch
  labels:
    app.kubernetes.io/part-of: spring-batch-argo-workflows
spec:
  templates:
    # ──────────────────────────────────────────────
    # trigger-job: POST /api/batch/jobs/{jobName}
    # - Job을 비동기 실행하고 executionId를 반환
    # - 네트워크/서버 오류 시 최대 8회 재시도 (Pod 재기동 ~1분 대응)
    # - 재시도 타임라인: 5s → 10s → 20s → 30s → 30s → 30s → 30s → 30s (총 ~185s)
    # 팟 재기동까지 고려하여 분단위로 재시도 하도록
    # ──────────────────────────────────────────────
    - name: trigger-job
      inputs:
        parameters:
          - name: jobName
          - name: params
            default: "{}"
      retryStrategy: # https://argo-workflows.readthedocs.io/en/latest/retries/
        limit: "8"
        backoff: # https://raw.githubusercontent.com/argoproj/argo-workflows/main/examples/retry-backoff.yaml
          duration: "5s" # 초기 대기 시간
          factor: 2 # 배수 (5s → 10s → 20s → 30s cap)
          maxDuration: "30s" # 최대 대기시간
        retryPolicy: Always
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/{{inputs.parameters.jobName}}"
        method: POST
        headers:
          - name: Content-Type
            value: application/json
        body: "{{inputs.parameters.params}}"
        successCondition: "response.statusCode == 202 || response.statusCode == 409"

    # ──────────────────────────────────────────────
    # poll-job-completion: GET /api/batch/jobs/executions/{id}
    # - COMPLETED 또는 FAILED가 될 때까지 15초 간격 폴링
    # - successCondition 미충족 시 retryStrategy가 재시도
    #   → 사실상 polling loop 역할
    # 최대 15분
    # ──────────────────────────────────────────────
    - name: poll-job-completion
      inputs:
        parameters:
          - name: executionId
      retryStrategy:
        limit: "60"
        backoff:
          duration: "15s"
          factor: 1
          maxDuration: "15s"
        retryPolicy: Always
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/executions/{{inputs.parameters.executionId}}"
        method: GET
        successCondition: "response.body.status == 'COMPLETED' || response.body.status == 'FAILED'"

    # ──────────────────────────────────────────────
    # long-poll-job-completion: GET /api/batch/jobs/executions/{id}
    # - 장시간 Job 전용 (최대 2시간)
    # - 30초 간격으로 최대 240회 폴링
    # 오래 걸리는 잡 전용
    # ──────────────────────────────────────────────
    - name: long-poll-job-completion
      inputs:
        parameters:
          - name: executionId
      retryStrategy:
        retryPolicy: Always
        limit: "240"
        backoff:
          duration: "30s"
          factor: 1
          maxDuration: "30s"
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/executions/{{inputs.parameters.executionId}}"
        method: GET
        successCondition: "response.body.status == 'COMPLETED' || response.body.status == 'FAILED'"

    # ──────────────────────────────────────────────
    # restart-job: POST /api/batch/jobs/executions/{id}/restart
    # - 실패한 Job을 재시작하고 새 executionId를 반환
    # ──────────────────────────────────────────────
    - name: restart-job
      inputs:
        parameters:
          - name: executionId
      retryStrategy:
        limit: "8"
        backoff:
          duration: "5s"
          factor: 2
          maxDuration: "30s"
        retryPolicy: Always
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/executions/{{inputs.parameters.executionId}}/restart"
        method: POST
        successCondition: "response.statusCode == 200"
