apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: batch-common
  namespace: batch
  labels:
    app.kubernetes.io/part-of: spring-batch-argo-workflows
spec:
  templates:
    # ──────────────────────────────────────────────
    # trigger-job: POST /api/batch/jobs/{jobName}
    # - Job을 비동기 실행하고 executionId를 반환
    # 팟 재기동까지 고려하여 분단위로 재시도 하도록
    # ──────────────────────────────────────────────
    - name: trigger-job
      inputs:
        parameters:
          - name: jobName
          - name: params
            default: "{}"
      retryStrategy: # https://argo-workflows.readthedocs.io/en/latest/retries/
        limit: "100" # maxDuration 설정으로 재시도 시간이 maxDuration 시간을 초과한다면 무시되는 설정이다.
        backoff: # https://raw.githubusercontent.com/argoproj/argo-workflows/main/examples/retry-backoff.yaml
          duration: "10s" # 초기 대기 시간
          factor: 1 # 배수
          maxDuration: "2m" # 최대 대기시간
        retryPolicy: Always
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/{{inputs.parameters.jobName}}"
        method: POST
        headers:
          - name: Content-Type
            value: application/json
        body: "{{inputs.parameters.params}}"
        successCondition: "response.statusCode == 202 || response.statusCode == 409"
    # ──────────────────────────────────────────────
    # poll-job-completion: GET /api/batch/jobs/executions/{id}
    # - COMPLETED 또는 FAILED가 될 때까지 10초 간격 폴링
    # - successCondition 미충족 시 retryStrategy가 재시도
    #   → 사실상 polling loop 역할
    # ──────────────────────────────────────────────
    - name: poll-job-completion
      inputs:
        parameters:
          - name: executionId
      retryStrategy:
        limit: "100"
        backoff:
          duration: "10s"
          factor: 1
          maxDuration: "15m"
        retryPolicy: Always
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/executions/{{inputs.parameters.executionId}}"
        method: GET
        successCondition: "response.statusCode == 200"

    # ──────────────────────────────────────────────
    # long-poll-job-completion: GET /api/batch/jobs/executions/{id}
    # - 장시간 Job 전용 (최대 2시간)
    # - 30초 간격 폴링 (최대 2시간)
    # 오래 걸리는 잡 전용
    # ──────────────────────────────────────────────
    - name: long-poll-job-completion
      inputs:
        parameters:
          - name: executionId
      retryStrategy:
        retryPolicy: Always
        limit: "100"
        backoff:
          duration: "30s"
          factor: 1
          maxDuration: "2h"
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/executions/{{inputs.parameters.executionId}}"
        method: GET
        successCondition: "response.statusCode == 200"
        # https://sourcegraph.com/github.com/argoproj/argo-workflows/-/blob/examples/http-success-condition.yaml

    # ──────────────────────────────────────────────
    # restart-job: POST /api/batch/jobs/executions/{id}/restart
    # - 실패한 Job을 재시작하고 새 executionId를 반환
    # ──────────────────────────────────────────────
    - name: restart-job
      inputs:
        parameters:
          - name: executionId
      retryStrategy:
        limit: "100"
        backoff:
          duration: "10s"
          factor: 1
          maxDuration: "2m"
        retryPolicy: Always
      http:
        url: "http://batch-api-server.batch.svc.cluster.local:8080/api/batch/jobs/executions/{{inputs.parameters.executionId}}/restart"
        method: POST
        successCondition: "response.statusCode == 200"
