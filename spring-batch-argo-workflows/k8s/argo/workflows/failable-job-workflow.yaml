apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: failable-job-
  namespace: batch
  labels:
    workflows.argoproj.io/type: batch-job
spec:
  entrypoint: run-failable-job
  arguments:
    parameters:
      - name: shouldFail
        value: "true"
  templates:
    - name: run-failable-job
      dag:
        tasks:
          # 1) failableJob 실행 (shouldFail 파라미터 전달)
          - name: trigger
            templateRef:
              name: batch-common
              template: trigger-job
            arguments:
              parameters:
                - name: job-name
                  value: failableJob
                - name: params
                  value: '{"shouldFail":"{{workflow.parameters.shouldFail}}"}'

          # 2) Job 완료 대기 (COMPLETED 또는 FAILED) — 409(중복 스킵)이면 poll 생략
          - name: poll
            depends: trigger
            when: "{{tasks.trigger.outputs.parameters.status-code}} == 202"
            templateRef:
              name: batch-common
              template: poll-job-completion
            arguments:
              parameters:
                - name: execution-id
                  value: "{{tasks.trigger.outputs.parameters.execution-id}}"

          # 3) FAILED인 경우에만 재시작
          - name: restart
            depends: poll
            when: "'{{tasks.poll.outputs.parameters.status}}' == 'FAILED'"
            templateRef:
              name: batch-common
              template: restart-job
            arguments:
              parameters:
                - name: execution-id
                  value: "{{tasks.trigger.outputs.parameters.execution-id}}"

          # 4) 재시작된 Job 완료 대기
          - name: poll-restarted
            depends: restart
            templateRef:
              name: batch-common
              template: poll-job-completion
            arguments:
              parameters:
                - name: execution-id
                  value: "{{tasks.restart.outputs.parameters.new-execution-id}}"
